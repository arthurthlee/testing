name: SWE-Agent Dependabot Fix


on:
  issues:
    types: [labeled]

# Prevent concurrent runs for the same issue
concurrency:
  group: swe-agent-${{ github.event.issue.number }}
  cancel-in-progress: true  # Cancel previous runs if new one starts

jobs:
  check-labels:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.result }}
    steps:
      - name: Check if issue has dependabot label and should run
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log(`Action: ${context.payload.action}`);
            console.log(`Label added: ${context.payload.label?.name || 'none'}`);

            // Only proceed if the open-swe label was just added
            if (context.payload.action === 'labeled') {
              const addedLabel = context.payload.label;
              if (!addedLabel || addedLabel.name !== 'open-swe') {
                console.log(`âŒ Wrong label added: ${addedLabel?.name || 'unknown'}`);
                return false;
              }
              console.log('âœ… open-swe label was just added');
            }

            // Verify the issue has both required labels
            const labels = context.payload.issue.labels.map(label => label.name);
            const hasOpenSwe = labels.includes('open-swe');
            const hasDependabot = labels.includes('dependabot');

            if (!hasOpenSwe || !hasDependabot) {
              console.log(`âŒ Missing required labels. Has open-swe: ${hasOpenSwe}, Has dependabot: ${hasDependabot}`);
              return false;
            }

            console.log('âœ… Issue has both required labels');

            // Check if we've already created a PR for this issue
            const { data: allPulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all'
            });

            const existingPR = allPulls.find(pr =>
              pr.head.ref.startsWith(`swe-agent-fix-issue-${context.payload.issue.number}`)
            );

            if (existingPR) {
              console.log(`âŒ PR already exists: ${existingPR.html_url}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `ðŸ¤– **SWE-Agent has already processed this issue**

                An existing pull request was found: ${existingPR.html_url}

                If you need to re-run SWE-Agent, please close the existing PR first.`
              });

              return false;
            }

            console.log('âœ… Should run SWE-Agent for this issue');
            return true;
  swe-agent-fix:
    needs: check-labels
    if: needs.check-labels.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install SWE-agent
        run: |
          git clone https://github.com/SWE-agent/SWE-agent.git
          cd SWE-agent
          python -m pip install --upgrade pip
          pip install --editable .

      - name: Set up API keys
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create .env file with API keys in the working directory where sweagent will look for it
          echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env
          echo "ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY" >> .env

          # Also set as environment variables for this session
          echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> $GITHUB_ENV
          echo "ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY" >> $GITHUB_ENV

      - name: Extract issue information
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const issueTitle = issue.title;
            const issueBody = issue.body || '';
            const repoUrl = context.payload.repository.clone_url;

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issueTitle);
            core.setOutput('issue_body', issueBody);
            core.setOutput('repo_url', repoUrl);

      - name: Create branch for fix
        run: |
          # Create a unique branch name with timestamp to avoid conflicts
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="swe-agent-fix-issue-${{ steps.issue_info.outputs.issue_number }}-${TIMESTAMP}"

          # Delete branch if it exists locally
          git branch -D $BRANCH_NAME 2>/dev/null || true

          # Delete branch if it exists remotely (ignore errors)
          git push origin --delete $BRANCH_NAME 2>/dev/null || true

          # Create and checkout new branch
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create problem statement file
        run: |
          cat > problem_statement.txt << 'EOF'
          ${{ steps.issue_info.outputs.issue_title }}

          ${{ steps.issue_info.outputs.issue_body }}
          EOF

      - name: Run SWE-agent
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue_info.outputs.issue_number }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MOCK_MODE: ${{ vars.MOCK_SWE_AGENT || 'false' }}
        run: |
          if [ "$MOCK_MODE" = "true" ]; then
            echo "ðŸ§ª MOCK MODE: Simulating SWE-agent execution"

            # Create a mock change to test the workflow
            echo "# Mock fix generated by SWE-agent" >> README.md
            echo "This is a test change to verify the GitHub Actions workflow works properly." >> README.md
            echo "" >> README.md
            echo "Issue #${{ steps.issue_info.outputs.issue_number }}: ${{ steps.issue_info.outputs.issue_title }}" >> README.md
            echo "Generated at: $(date)" >> README.md

            echo "âœ… Mock SWE-agent completed successfully"
          else
            echo "ðŸ¤– Running real SWE-agent"
            cd SWE-agent
            sweagent run \
              --agent.model.name=claude-sonnet-4-20250514 \
              --agent.model.per_instance_cost_limit=3.00 \
              --env.repo.path=.. \
              --problem_statement.path=../problem_statement.txt
          fi

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "SWE-Agent Bot"
          git commit -m "ðŸ¤– SWE-Agent: Fix for issue #${{ steps.issue_info.outputs.issue_number }}

          Automated fix generated by SWE-Agent for:
          ${{ steps.issue_info.outputs.issue_title }}

          Resolves #${{ steps.issue_info.outputs.issue_number }}"

      - name: Push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ env.BRANCH_NAME }}

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– SWE-Agent: Fix for issue #${{ steps.issue_info.outputs.issue_number }}`,
              head: '${{ env.BRANCH_NAME }}',
              base: 'main', // Change to your default branch if different
              body: `## ðŸ¤– Automated Fix by SWE-Agent

            This pull request contains automated fixes generated by SWE-Agent for the following issue:

            **Issue:** #${{ steps.issue_info.outputs.issue_number }} - ${{ steps.issue_info.outputs.issue_title }}

            ### Changes Made
            SWE-Agent analyzed the codebase and generated fixes based on the issue description.

            ### Review Notes
            - This is an automated fix generated by AI
            - Please review all changes carefully before merging
            - Run tests to ensure the fix doesn't introduce regressions
            - Consider the fix as a starting point that may need refinement

            **Closes #${{ steps.issue_info.outputs.issue_number }}**

            ---
            *Generated by [SWE-Agent](https://github.com/princeton-nlp/SWE-agent)*`
              });

              // Add labels to the PR
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pullRequest.number,
                labels: ['swe-agent', 'automated-fix', 'dependabot']
              });

              console.log(`Created PR #${pullRequest.number}: ${pullRequest.html_url}`);

      - name: Comment on issue
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue_info.outputs.issue_number }},
              body: `ðŸ¤– **SWE-Agent has analyzed this issue and created a potential fix!**

              A pull request with automated fixes has been created. Please review the changes and test thoroughly before merging.

              The fixes are available in the pull request linked above. If the fix doesn't fully resolve the issue, please provide additional context and I can try again.`
            });

      - name: Handle no changes case
        if: steps.changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue_info.outputs.issue_number }},
              body: `ðŸ¤– **SWE-Agent Analysis Complete**

              SWE-Agent has analyzed this issue but was unable to generate any code changes. This could mean:

              - The issue requires human intervention or judgment
              - The problem description needs more specificity
              - The fix requires architectural changes beyond SWE-Agent's current scope
              - The issue may already be resolved

              Please review the issue details and consider providing more specific reproduction steps or context.`
            });

      - name: Clean up on failure
        if: failure()
        run: |
          git checkout main 2>/dev/null || git checkout master 2>/dev/null || true
          git branch -D ${{ env.BRANCH_NAME }} 2>/dev/null || true